<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>Robot Control Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-6">
  <!-- 标题 -->
  <h1 class="text-5xl font-extrabold mb-12">Robot Control Dashboard</h1>

  <!-- 控制区卡片：使用命名网格区域，方便调整按钮位置 -->
  <section class="bg-gray-800 rounded-2xl shadow-lg p-6 mb-12"
           style="
             display: grid;
             grid-template-columns: repeat(3, 80px);
             grid-template-rows: repeat(2, 80px);
             grid-template-areas:
               '. up .'
               'left down right';
             gap: 1rem;
           ">
    <button id="btn-w" class="btn-control bg-gray-700 hover:bg-gray-600 rounded-lg flex items-center justify-center text-2xl"
            style="grid-area: up;">↑</button>
    <button id="btn-a" class="btn-control bg-gray-700 hover:bg-gray-600 rounded-lg flex items-center justify-center text-2xl"
            style="grid-area: left;">←</button>
    <button id="btn-s" class="btn-control bg-gray-700 hover:bg-gray-600 rounded-lg flex items-center justify-center text-2xl"
            style="grid-area: down;">↓</button>
    <button id="btn-d" class="btn-control bg-gray-700 hover:bg-gray-600 rounded-lg flex items-center justify-center text-2xl"
            style="grid-area: right;">→</button>
  </section>

  <!-- 遥测区卡片 -->
  <section class="bg-gray-800 rounded-2xl shadow-lg p-6 w-full max-w-xl flex flex-col sm:flex-row justify-between items-center gap-6">
    <!-- 电池进度（百分比在上，进度条在下） -->
    <div class="flex-1 w-full">
      <p class="mb-2 text-sm font-medium text-center">Battery</p>
      <p id="bat-status" class="mb-2 text-center text-xl font-semibold">--%</p>
      <div class="w-full bg-gray-700 rounded-lg overflow-hidden h-4">
        <div id="bat-fill" class="h-full bg-green-500 w-0 transition-all"></div>
      </div>
    </div>
    <!-- 速度文本及进度条 -->
    <div class="flex-1 w-full">
      <p class="mb-2 text-sm font-medium text-center">Speed</p>
      <p id="status" class="text-xl font-semibold text-center mb-2">--</p>
      <div class="w-full bg-gray-700 rounded-lg overflow-hidden h-4">
        <div id="speed-fill" class="h-full bg-blue-500 w-0 transition-all"></div>
      </div>
    </div>
  </section>

  <script>
    // —— Telemetry WebSocket ——
    const host = location.hostname;
    const wsURL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + host + ':9001/robot';
    let ws;
    try {
      ws = new WebSocket(wsURL);
      ws.onopen = () => console.log('WS connected');
      ws.onclose = () => console.log('WS closed');
      ws.onmessage = ({ data }) => {
        try {
          const msg = JSON.parse(data);
          // Battery
          if (typeof msg.tele?.bat_v === 'number') {
            const pct = Math.min(Math.max((msg.tele.bat_v - 5.5) / 2, 0), 1);
            document.getElementById('bat-status').textContent = `${(pct * 100).toFixed(1)}%`;
            const fill = document.getElementById('bat-fill');
            fill.style.width = `${(pct * 100).toFixed(1)}%`;
            fill.style.background = pct < 0.2
              ? 'var(--crit)' 
              : pct < 0.4 
                ? 'var(--low)' 
                : 'var(--full)';
          }
          // Speed
          if (typeof msg.tele?.speed === 'number') {
            const speed = msg.tele.speed;
            document.getElementById('status').textContent = `${speed}`;
            const maxSpeed = 300;
            const spPct = Math.min(Math.max(speed / maxSpeed, 0), 1);
            document.getElementById('speed-fill').style.width = `${(spPct * 100).toFixed(1)}%`;
          }
        } catch (e) { console.warn('Telemetry parse error', e); }
      };
    } catch (e) {
      console.warn('WebSocket init failed, fallback without telemetry', e);
      ws = { send: () => {}, readyState: WebSocket.CLOSED };
    }

    // —— Control Logic ——
    const held = new Set();
    const opposites = { w: 's', s: 'w', a: 'd', d: 'a' };
    function send(cmd) {
      if (ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(cmd));
      else console.log('cmd', cmd);
    }
    function update() {
      const S = 150;
      let L = 0, R = 0;
      if (held.has('w')) { L += S; R += S; }
      if (held.has('s')) { L -= S; R -= S; }
      if (held.has('a')) { L -= S; R += S; }
      if (held.has('d')) { L += S; R -= S; }
      send({ cmd: 'set_speed', left: L, right: R });
    }

    // —— 事件绑定 ——
    ['w','a','s','d'].forEach(k => {
      const btn = document.getElementById('btn-' + k);
      ['pointerdown','mousedown','touchstart'].forEach(evt =>
        btn.addEventListener(evt, e => { e.preventDefault(); hold(k); })
      );
      ['pointerup','mouseup','touchend','pointerleave'].forEach(evt =>
        btn.addEventListener(evt, e => { e.preventDefault(); release(k); })
      );
    });
    window.addEventListener('keydown', e => {
      const k = e.key.toLowerCase();
      if (['w','a','s','d'].includes(k) && !held.has(k)) {
        e.preventDefault(); hold(k);
      }
    });
    window.addEventListener('keyup', e => {
      const k = e.key.toLowerCase();
      if (['w','a','s','d'].includes(k)) {
        e.preventDefault(); release(k);
      }
    });
    function hold(k) {
      const opp = opposites[k];
      if (held.has(opp)) release(opp);
      held.add(k);
      const btn = document.getElementById('btn-' + k);
      btn.classList.remove('bg-gray-700');
      btn.classList.add('bg-blue-500');
      update();
    }
    function release(k) {
      held.delete(k);
      const btn = document.getElementById('btn-' + k);
      btn.classList.remove('bg-blue-500');
      btn.classList.add('bg-gray-700');
      update();
    }
  </script>
</body>
</html>
